# 瑕疵检测系统

## 项目概述
这是一个基于Jetson Orin NX开发的视觉瑕疵检测系统，专为工业生产线设计。系统通过位置传感器检测产品，控制传送带停止，使用摄像头拍摄产品图像，然后利用YOLO模型进行瑕疵检测，最后根据检测结果决定是否启动剔除机构，并重新启动传送带以进行下一个产品的处理。

## 系统架构

### 硬件要求
- NVIDIA Jetson Orin NX开发板
- 工业摄像头 (支持MVS相机SDK)
- 位置传感器
- 传送带控制系统
- 剔除机构 (选配)
- 显示设备 (选配)

### 软件依赖
- Python 3.10+
- CUDA支持
- Ultralytics YOLO (v8.3.96+)
- OpenCV 或 PIL用于图像处理
- MVS相机SDK

## 功能特点
- **实时检测**：使用YOLO模型进行高效的瑕疵检测
- **自动化工作流**：从传感器触发到检测结果输出的全自动流程
- **可视化界面**：可选的结果显示界面
- **数据记录**：保存检测图像和结果元数据
- **API集成**：支持将结果上传到远程服务器
- **统计分析**：记录系统运行统计数据
- **可配置参数**：通过配置文件灵活调整系统参数

## 系统流程
1. 位置传感器检测到产品到达检测区域
2. 控制传送带停止运行
3. 摄像头捕获产品图像
4. YOLO模型进行瑕疵检测
5. 照片和检测结果上传服务器
6. 根据检测结果决定是否激活剔除机构
7. 重启传送带，继续下一个产品的检测

## 安装与配置
### 基础环境配置
```
# 安装必要依赖
pip install numpy==1.23.5
pip install torch torchvision
pip install ultralytics
pip install opencv-python-headless

# 如果需要使用ONNX运行时
pip install onnxruntime-gpu
```
### 配置文件说明
系统使用JSON格式的配置文件，主要参数包括：
- 摄像头设置
- 传送带控制参数
- 模型路径与检测阈值
- 剔除机构参数
- 显示设置
- API接口配置

## 使用方法
### 启动系统
```
python main.py --config config.json
```
### 常用参数
- `--config`: 指定配置文件路径
- `--log-level`: 设置日志级别 (debug, info, warning, error)
- `--no-display`: 禁用结果显示界面
- `--no-ejection`: 禁用剔除机构
- `--test-ejector`: 启动前测试剔除机构
- `--show-stats`: 显示系统统计信息

## 项目结构
```
defect_inspection/
    ├── main.py                  # 主程序入口
    ├── config.json              # 配置文件
    ├── src/
    │   ├── camera.py            # 摄像头控制模块
    │   ├── conveyor.py          # 传送带控制模块
    │   ├── detector.py          # YOLO检测器模块
    │   ├── display.py           # 图像显示模块
    │   ├── api_client.py        # API客户端模块
    │   └── utils.py             # 实用工具函数
    ├── models/                  # 模型目录
    │   └── defect_model.onnx    # YOLO瑕疵检测模型
    └── data/                    # 数据目录
            └── images/              # 保存的图像
```

## 注意事项
- 确保Jetson设备已正确安装GPU加速库以获得最佳性能
- 摄像头需要使用MVS相机SDK进行配置
- 根据实际生产线速度调整配置参数
- 定期备份检测结果和系统日志

## 故障排除
- **摄像头连接问题**：检查MVS SDK安装和相机权限
- **检测速度慢**：尝试使用优化的ONNX或TensorRT模型
- **剔除机构不工作**：检查GPIO连接和权限设置
- **系统崩溃**：查看日志文件分析错误原因

## 性能优化
- 使用TensorRT加速模型推理
- 优化图像预处理步骤
- 调整传送带速度和停止延迟
- 根据实际需求调整检测阈值

## 开发注意事项
- 开发新功能时请遵循现有模块化结构
- 添加充分的日志记录以便调试
- 确保异常处理能够保证系统稳定运行
- 定期测试系统在长时间运行下的稳定性